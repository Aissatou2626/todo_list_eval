<?php
// Import des ressources
require_once '../db_connexion.php';

session_start();
if (isset($_SESSION['user_id'])) {
    header('../authentification/authCon.php');
    exit();
}

if ($_SERVER['REQUEST_METHOD'] == 'POST') {
    if (isset($_POST['create'])) {
        $titre = $_POST['titre'];
        $date = $_POST['date'];
        $action = isset($_POST['action']) ? 1 : 0;

        $stmt = $pdo->prepare("INSERT INTO taches (user_id, titre, date, action) VALUES (?, ?, ?, ?)");
        $stmt->execute([$_SESSION['user_id'], $titre, $date, $action]);
    }

    if (isset($_POST['update'])) {
        $id = $_POST['id'];
        $titre = $_POST['titre'];
        $date = $_POST['date'];
        $action = isset($_POST['action']) ? 1 : 0;

        $stmt = $pdo->prepare("UPDATE taches SET titre = ?, date = ?, action = ? WHERE id = ? AND user_id = ?");
        $stmt->execute([$titre, $date, $action, $id, $_SESSION['user_id']]);
    }

    if (isset($_POST['delete'])) {
        $id = $_POST['id'];

        $stmt = $pdo->prepare("DELETE FROM taches WHERE id = ? AND user_id = ?");
        $stmt->execute([$id, $_SESSION['user_id']]);
    }
}

$taches = $pdo->prepare("SELECT * FROM taches WHERE user_id = ?");
$taches->execute([$_SESSION['user_id']]);
?>

<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>TODO List</title>
</head>
<body>
    <?php include 'navbar.php'; ?>
    <h1>TODO List</h1>

    <h2>Créer une TODO</h2>
    <form method="POST" action="">
        <input type="text" name="titre" placeholder="Titre" required>
        <input type="date" name="date" required>
        <label for="action">Action :</label>
        <input type="checkbox" name="action">
        <button type="submit" name="create">Créer</button>
    </form>

    <h2>Vos TODO Lists</h2>
    <ul>
        <?php while ($tache = $taches->fetch()): ?>
            <li>
                <form method="POST" action="">
                    <input type="hidden" name="id" value="<?php echo $tache['id']; ?>">
                    <input type="text" name="titre" value="<?php echo htmlspecialchars($tache['titre']); ?>" required>
                    <input type="date" name="date" value="<?php echo $tache['date']; ?>" required>
                    <label for="action">Action :</label>
                    <input type="checkbox" name="action" <?php if ($tache['action']) echo 'checked'; ?>>
                    <button type="submit" name="update">Modifier</button>
                    <button type="submit" name="delete">Supprimer</button>
                </form>
            </li>
        <?php endwhile; ?>
    </ul>
</body>
</html>



<li>
                <form method="POST" action="">
                    <input type="hidden" name="id" value="<?php echo $tache['id']; ?>">
                    <input type="hidden" name="user_id" value="<?php echo $tache['user_id']; ?>">
                    <input type="text" name="titre" value="<?php echo htmlspecialchars($tache['titre']); ?>" required>
                    <input type="date" name="date" value="<?php echo $tache['date']; ?>" required>
                    <label for="action">Action :</label>
                    <input type="checkbox" name="action" <?php if ($tache['action']) echo 'checked'; ?>>
                    <button type="submit" name="update">Modifier</button> 
                    <button type="submit" name="delete">Supprimer</button>
                </form>
            </li>
        <?php endforeach; ?>
    </ul>



    <?php
// Import des ressources
require_once '../db_connexion.php';
session_start();

// //Je verifie que $_SESSION a bien  récupérer un utilisateur
// if (isset($_SESSION['userId'])) {
//     $userId = $_SESSION['userId'];
// }
// else{
//     header('Location: ../authentification/authCon.php');
// }

//Initialisation de la PDO pour se connecter à la BDD
$pdo = new PDO("mysql:host=$host;dbname=$db", $user, $password);

// Requête sur la table
$requete = 'SELECT * FROM taches';

// Je prépare la requête
$stmt = $pdo->query($requete);
// Je stocke mes données dans la variable listeTaches
$listeTaches = $stmt->fetchAll(PDO::FETCH_ASSOC);

// Si le $_POST est défini, 
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    // Je nettoie les données du formulaire
    $_POST = filter_input_array(INPUT_POST, [
        'titre' => FILTER_SANITIZE_FULL_SPECIAL_CHARS,
        'action' => FILTER_VALIDATE_BOOLEAN,
        'date' => FILTER_SANITIZE_FULL_SPECIAL_CHARS,


    ]);

    //J'hydrate les variables pour remplacer les paramètres de la requête

    $titre = $_POST['titre'];
    $action = isset($_POST['action']) ? 1 : 0;
    $date = $_POST['date'];


    // J'écris ma requête paramétrée et nommée
    $requete = 'INSERT INTO taches (titre, date, action) VALUES (:titre, :date, :action)';

    // Je remplace les paramètres par les valeurs
    $stmt = $pdo->prepare($requete);
    $stmt->bindParam('titre', $titre);
    $stmt->bindParam('action', $action);
    $stmt->bindParam('date', $date);


    $stmt->execute();

    $nb = $stmt->rowcount();

    if ($nb > 0) {
        header('Location: /index.php');
    }

    //Recupération de la date du jour
    //  $today =  date('Y-m-d');
}

?>

<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TODO List</title>
    <link rel="stylesheet" href="../styles/main.css">
</head>

<body>

    <div class="form-container ">
        <h2>Créer une TODO</h2>
        <form method="POST" action="">
            <input type="text" name="titre" placeholder="Titre" required>

            <label for="action">Action :</label>
            <input type="checkbox" name="action">

            <input type="date" name="date">

            <button type="submit" name="create">Créer</button>
        </form>

    </div>


    <h2>Vos tâches</h2>


    <!-- Afficher toutes les tâches-->
    <table class="form-container ">
        <tr>
            <th>Id</th>
            <th>User_id</th>
            <th>Titre</th>
            <th>Action</th>
            <th>Date</th>
            <th>Date de modification</th>
        </tr>


        <?php
        // Afficher les données  de la todo list
        foreach ($listeTaches as $key => $tache) {
            echo '<tr>';
            foreach ($tache as $valeur) {
                echo '<td>' . $valeur . '</td>';
            }
            echo '</tr>';
        }

        ?>
    </table>

</body>

</html>